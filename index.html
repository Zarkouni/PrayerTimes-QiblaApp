<!DOCTYPE html>
<html lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>خريطة اتجاه القبلة باستخدام OpenStreetMap</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <style>
        #map {
            width: 100%;
            height: 400px;
        }
        #status {
            font-size: 18px;
            font-weight: bold;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h2>اتجاه القبلة</h2>
        <p>اضغط على الزر أدناه لتحديد موقعك وعرض الخريطة.</p>

        <!-- زر لتحديد الموقع -->
        <button onclick="getLocationAndDisplayQibla()">استخدام موقعي الحالي</button>

        <!-- عرض زاوية القبلة -->
        <p id="qibla-angle"></p>

        <!-- منطقة عرض الخريطة -->
        <div id="map"></div>

        <!-- حالة الاتجاه -->
        <p id="status"></p>
    </div>

    <!-- مكتبة Leaflet.js لعرض الخريطة -->
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

    <script>
        // إحداثيات الكعبة
        const kaabaCoordinates = {
            lat: 21.4225,
            lon: 39.8262
        };

        let userLat, userLon, qiblaDirection;

        // حساب زاوية القبلة بناءً على موقع المستخدم
        function calculateQiblaDirection(userLat, userLon) {
            const kaabaLat = kaabaCoordinates.lat * (Math.PI / 180); // تحويل إلى راديان
            const kaabaLon = kaabaCoordinates.lon * (Math.PI / 180);
            const userLatRad = userLat * (Math.PI / 180);
            const userLonRad = userLon * (Math.PI / 180);

            const deltaLon = kaabaLon - userLonRad;

            const x = Math.sin(deltaLon) * Math.cos(kaabaLat);
            const y = Math.cos(userLatRad) * Math.sin(kaabaLat) - Math.sin(userLatRad) * Math.cos(kaabaLat) * Math.cos(deltaLon);
            const qiblaAngle = Math.atan2(x, y) * (180 / Math.PI);

            return (qiblaAngle + 360) % 360; // التأكد من أن الزاوية بين 0 و 360
        }

        // تحديث زاوية القبلة على الصفحة
        function displayQiblaAngle(qiblaDirection) {
            const qiblaAngleText = document.getElementById('qibla-angle');
            qiblaAngleText.textContent = `زاوية القبلة: ${qiblaDirection.toFixed(2)}° من الشمال الحقيقي`;
        }

        // تهيئة الخريطة باستخدام Leaflet.js
        function initializeMap(userLat, userLon) {
            const userLocation = [userLat, userLon];
            const kaabaLocation = [kaabaCoordinates.lat, kaabaCoordinates.lon];

            const map = L.map('map').setView(userLocation, 6); // تحديد مستوى التكبير

            // تحميل الخريطة من OpenStreetMap
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);

            // إضافة مؤشر لموقع المستخدم
            L.marker(userLocation).addTo(map).bindPopup('موقعك الحالي').openPopup();

            // رسم خط من موقع المستخدم إلى الكعبة
            const line = L.polyline([userLocation, kaabaLocation], { color: 'red' }).addTo(map);

            // تكبير الخريطة لاحتواء الخط
            map.fitBounds(line.getBounds());
        }

        // جلب الموقع الجغرافي للمستخدم وحساب اتجاه القبلة
        function getLocationAndDisplayQibla() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        userLat = position.coords.latitude;
                        userLon = position.coords.longitude;

                        // حساب اتجاه القبلة
                        qiblaDirection = calculateQiblaDirection(userLat, userLon);

                        // عرض زاوية القبلة
                        displayQiblaAngle(qiblaDirection);

                        // عرض الخريطة مع اتجاه القبلة
                        initializeMap(userLat, userLon);

                        // مراقبة اتجاه الجهاز
                        if (window.DeviceOrientationEvent) {
                            window.addEventListener('deviceorientation', handleOrientation);
                        } else {
                            alert('جهازك لا يدعم البوصلة.');
                        }
                    },
                    () => {
                        alert('يرجى تمكين الوصول إلى الموقع الجغرافي.');
                    }
                );
            } else {
                alert('المتصفح لا يدعم تحديد الموقع الجغرافي.');
            }
        }

        // معالجة بيانات الاتجاه من بوصلة الجهاز
        function handleOrientation(event) {
            const alpha = event.alpha; // زاوية الجهاز بالنسبة للشمال الحقيقي

            if (alpha !== null && qiblaDirection !== undefined) {
                // حساب الفارق بين اتجاه الجهاز واتجاه القبلة
                const diff = Math.abs(qiblaDirection - alpha);

                const statusText = document.getElementById('status');

                if (diff < 10 || diff > 350) {
                    statusText.textContent = "أنت في الاتجاه الصحيح نحو القبلة";
                    statusText.style.color = "green";
                } else {
                    statusText.textContent = "يرجى تعديل اتجاهك نحو القبلة";
                    statusText.style.color = "red";
                }
            }
        }
    </script>
</body>
</html>
